'use babel';
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import React from 'preact-compat';
import moment from 'moment';
import TooltipContainer from './TooltipContainer';
import BlameTooltip from './BlameTooltip';
import * as GitData from '../data/GitData';
import * as IntegrationData from '../data/IntegrationData';
import * as ConfigManager from '../ConfigManager';
class GutterItem extends React.Component {
    constructor(...props) {
        super(...props);
        this.state = {
            commit: {},
            pullRequests: [],
            issues: [],
            metadata: {},
        };
    }
    componentWillMount() {
        this.setState({ commit: this.props.commit });
        if (this.props.commit.commitHash.substr(0, 6) !== '000000') {
            this.fetchCommitData();
            GitData.getRepoMetadata(this.props.commit.repoPath)
                .then((metadata) => {
                this.setState(Object.assign({}, this.state, { metadata }));
            });
        }
    }
    componentDidMount() {
        if (this.props.commit.commitHash.substr(0, 6) !== '000000') {
            IntegrationData
                .getPullRequestsForCommit(`${this.state.commit.repoPath}`, this.state.commit.commitHash)
                .then((pullRequests) => {
                this.setState(Object.assign({}, this.state, { pullRequests: pullRequests }));
                pullRequests.map(this.getIssuesForPullRequest.bind(this));
                // Refresh the commit data
                this.fetchCommitData();
            });
        }
    }
    fetchCommitData() {
        if (this.props.commit.commitHash.substr(0, 6) !== '000000') {
            GitData.getCommit(this.props.commit.repoPath, this.props.commit.commitHash)
                .then((commit) => {
                this.setState(Object.assign({}, this.state, { commit: Object.assign({}, this.state.commit, commit) }));
            });
        }
    }
    getIssuesForPullRequest(pullRequest) {
        return __awaiter(this, void 0, void 0, function* () {
            if (pullRequest) {
                const issues = yield Promise.all(pullRequest.relatedIssueKeys.map(issueKey => IntegrationData.getIssue(this.state.commit.repoPath, issueKey)));
                this.setState(Object.assign({}, this.state, { issues }));
            }
            else {
                this.setState(Object.assign({}, this.state, { issues: [] }));
            }
        });
    }
    tooltip() {
        return (React.createElement(BlameTooltip, { emitter: this.props.emitter, commit: this.state.commit, commitDay: this.props.commitDay, firstCommitDate: this.props.firstCommitDate, pullRequests: this.state.pullRequests, issues: this.state.issues, metadata: this.state.metadata }));
    }
    formattedText() {
        const commit = this.props.commit;
        const date = commit.commitedAt;
        const formattedDate = moment(date).format(ConfigManager.get('gutterDateFormat'));
        let author = commit.author;
        if (author == 'Not Committed Yet')
            return `${author}`;
        if (ConfigManager.get('truncateGutterNames')) {
            const splitAuthor = author.split(' ');
            if (splitAuthor.length > 1) {
                const lastName = splitAuthor.pop();
                const initials = splitAuthor.map((part) => {
                    return part[0].toUpperCase();
                }).join(' ');
                author = `${initials}. ${lastName}`;
            }
        }
        return `${formattedDate} ${author}`;
    }
    render() {
        if (this.state.commit.commitHash.substr(0, 6) === '000000') {
            return (React.createElement("div", { className: "gutter-text" }, this.formattedText()));
        }
        return (React.createElement("div", null,
            React.createElement(TooltipContainer, { className: "gutter-text", tooltipContent: this.tooltip.bind(this) }, this.formattedText()),
            React.createElement(TooltipContainer, { style: { background: this.props.inidcatorColor }, className: "gutter-age" })));
    }
}
export default GutterItem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3V0dGVySXRlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb21wb25lbnRzL0d1dHRlckl0ZW0udHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7O0FBRVosT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBQ2xDLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLGdCQUFnQixNQUFNLG9CQUFvQixDQUFDO0FBRWxELE9BQU8sWUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxPQUFPLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxLQUFLLGVBQWUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRCxPQUFPLEtBQUssYUFBYSxNQUFNLGtCQUFrQixDQUFDO0FBa0JsRCxnQkFBaUIsU0FBUSxLQUFLLENBQUMsU0FBZ0M7SUFFN0QsWUFBWSxHQUFHLEtBQUs7UUFDbEIsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLE1BQU0sRUFBRSxFQUFFO1lBQ1YsWUFBWSxFQUFFLEVBQUU7WUFDaEIsTUFBTSxFQUFFLEVBQUU7WUFDVixRQUFRLEVBQUUsRUFBRTtTQUNiLENBQUE7SUFDSCxDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUMsQ0FBQyxDQUFDO1FBQzNDLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFBLENBQUM7WUFDeEQsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO2lCQUNoRCxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtnQkFDakIsSUFBSSxDQUFDLFFBQVEsbUJBQ1IsSUFBSSxDQUFDLEtBQUssSUFDYixRQUFRLElBQ1IsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztJQUNILENBQUM7SUFFRCxpQkFBaUI7UUFDZixFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ3pELGVBQWU7aUJBQ1osd0JBQXdCLENBQ3ZCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FDN0I7aUJBQ0EsSUFBSSxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxRQUFRLG1CQUNSLElBQUksQ0FBQyxLQUFLLElBQ2IsWUFBWSxFQUFFLFlBQVksSUFDMUIsQ0FBQztnQkFDSCxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDMUQsMEJBQTBCO2dCQUMxQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDekIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBQ0gsQ0FBQztJQUVELGVBQWU7UUFDYixFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQSxDQUFDO1lBQ3hELE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztpQkFDeEUsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLFFBQVEsbUJBQ1IsSUFBSSxDQUFDLEtBQUssSUFDYixNQUFNLG9CQUNELElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUNqQixNQUFNLEtBRVgsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztJQUNILENBQUM7SUFFSyx1QkFBdUIsQ0FBQyxXQUFXOztZQUN2QyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FDL0QsUUFBUSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FDM0UsQ0FBQyxDQUFDO2dCQUNILElBQUksQ0FBQyxRQUFRLG1CQUFNLElBQUksQ0FBQyxLQUFLLElBQUUsTUFBTSxJQUFHLENBQUM7WUFDM0MsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLElBQUksQ0FBQyxRQUFRLG1CQUFNLElBQUksQ0FBQyxLQUFLLElBQUUsTUFBTSxFQUFFLEVBQUUsSUFBRyxDQUFBO1lBQzlDLENBQUM7UUFDSCxDQUFDO0tBQUE7SUFFRCxPQUFPO1FBQ0wsTUFBTSxDQUFDLENBQ0wsb0JBQUMsWUFBWSxJQUNYLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFDM0IsTUFBTSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQy9CLGVBQWUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFDM0MsWUFBWSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUNyQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQ3pCLFFBQVEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FDN0IsQ0FDSCxDQUFBO0lBQ0gsQ0FBQztJQUVELGFBQWE7UUFDWCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUNqQyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDO1FBQy9CLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7UUFDakYsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUMzQixFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksbUJBQW1CLENBQUM7WUFDaEMsTUFBTSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUE7UUFDcEIsRUFBRSxDQUFBLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUEsQ0FBQztZQUMzQyxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3RDLEVBQUUsQ0FBQSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUEsQ0FBQztnQkFDekIsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNuQyxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQ3hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUE7Z0JBQzlCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDYixNQUFNLEdBQUcsR0FBRyxRQUFRLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDdEMsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsR0FBRyxhQUFhLElBQUksTUFBTSxFQUFFLENBQUE7SUFDckMsQ0FBQztJQUVELE1BQU07UUFDSixFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQSxDQUFDO1lBQ3hELE1BQU0sQ0FBQyxDQUNMLDZCQUFLLFNBQVMsRUFBQyxhQUFhLElBQ3pCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FDakIsQ0FDUCxDQUFDO1FBQ0osQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUNMO1lBQ0Usb0JBQUMsZ0JBQWdCLElBQ2YsU0FBUyxFQUFDLGFBQWEsRUFDdkIsY0FBYyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUV0QyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQ0o7WUFDbkIsb0JBQUMsZ0JBQWdCLElBQ2YsS0FBSyxFQUFFLEVBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFDLEVBQzlDLFNBQVMsRUFBQyxZQUFZLEdBQ3RCLENBQ0UsQ0FDUCxDQUFDO0lBQ0osQ0FBQztDQUVGO0FBRUQsZUFBZSxVQUFVLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IFJlYWN0IGZyb20gJ3ByZWFjdC1jb21wYXQnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IFRvb2x0aXBDb250YWluZXIgZnJvbSAnLi9Ub29sdGlwQ29udGFpbmVyJztcbmltcG9ydCBCdWlsZFN0YXR1cyBmcm9tICcuL0J1aWxkU3RhdHVzJztcbmltcG9ydCBCbGFtZVRvb2x0aXAgZnJvbSAnLi9CbGFtZVRvb2x0aXAnO1xuaW1wb3J0ICogYXMgR2l0RGF0YSBmcm9tICcuLi9kYXRhL0dpdERhdGEnO1xuaW1wb3J0ICogYXMgSW50ZWdyYXRpb25EYXRhIGZyb20gJy4uL2RhdGEvSW50ZWdyYXRpb25EYXRhJztcbmltcG9ydCAqIGFzIENvbmZpZ01hbmFnZXIgZnJvbSAnLi4vQ29uZmlnTWFuYWdlcic7XG5pbXBvcnQgKiBhcyBBbmFseXRpY3MgZnJvbSAnLi4vc3RlcHNpemUvQW5hbHl0aWNzJztcbmltcG9ydCAqIGFzIEludGVncmF0aW9uTm90aWZpY2F0aW9uIGZyb20gJy4uL2ludGVyZmFjZS9JbnRlZ3JhdGlvbk5vdGlmaWNhdGlvbic7XG5cbmludGVyZmFjZSBJR3V0dGVySXRlbVByb3BzIHtcbiAgY29tbWl0OiBhbnk7XG4gIGVtaXR0ZXI6IGFueTtcbiAgaW5pZGNhdG9yQ29sb3I6IHN0cmluZztcbiAgZmlyc3RDb21taXREYXRlOiBEYXRlO1xuICBjb21taXREYXk6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIElHdXR0ZXJJdGVtU3RhdGUge1xuICBjb21taXQ6IGFueTtcbiAgcHVsbFJlcXVlc3RzOiBhbnk7XG4gIGlzc3VlczogQXJyYXk8YW55Pjtcbn1cblxuY2xhc3MgR3V0dGVySXRlbSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJR3V0dGVySXRlbVByb3BzLCBhbnk+IHtcblxuICBjb25zdHJ1Y3RvciguLi5wcm9wcyl7XG4gICAgc3VwZXIoLi4ucHJvcHMpO1xuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBjb21taXQ6IHt9LFxuICAgICAgcHVsbFJlcXVlc3RzOiBbXSxcbiAgICAgIGlzc3VlczogW10sXG4gICAgICBtZXRhZGF0YToge30sXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbE1vdW50KCl7XG4gICAgdGhpcy5zZXRTdGF0ZSh7Y29tbWl0OiB0aGlzLnByb3BzLmNvbW1pdH0pO1xuICAgIGlmKHRoaXMucHJvcHMuY29tbWl0LmNvbW1pdEhhc2guc3Vic3RyKDAsNikgIT09ICcwMDAwMDAnKXtcbiAgICAgIHRoaXMuZmV0Y2hDb21taXREYXRhKCk7XG4gICAgICBHaXREYXRhLmdldFJlcG9NZXRhZGF0YSh0aGlzLnByb3BzLmNvbW1pdC5yZXBvUGF0aClcbiAgICAgICAgLnRoZW4oKG1ldGFkYXRhKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgICAgICAgbWV0YWRhdGFcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKXtcbiAgICBpZih0aGlzLnByb3BzLmNvbW1pdC5jb21taXRIYXNoLnN1YnN0cigwLDYpICE9PSAnMDAwMDAwJykge1xuICAgICAgSW50ZWdyYXRpb25EYXRhXG4gICAgICAgIC5nZXRQdWxsUmVxdWVzdHNGb3JDb21taXQoXG4gICAgICAgICAgYCR7dGhpcy5zdGF0ZS5jb21taXQucmVwb1BhdGh9YCxcbiAgICAgICAgICB0aGlzLnN0YXRlLmNvbW1pdC5jb21taXRIYXNoXG4gICAgICAgIClcbiAgICAgICAgLnRoZW4oKHB1bGxSZXF1ZXN0cykgPT4ge1xuICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgICAgICAgIHB1bGxSZXF1ZXN0czogcHVsbFJlcXVlc3RzXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcHVsbFJlcXVlc3RzLm1hcCh0aGlzLmdldElzc3Vlc0ZvclB1bGxSZXF1ZXN0LmJpbmQodGhpcykpO1xuICAgICAgICAgIC8vIFJlZnJlc2ggdGhlIGNvbW1pdCBkYXRhXG4gICAgICAgICAgdGhpcy5mZXRjaENvbW1pdERhdGEoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZmV0Y2hDb21taXREYXRhKCl7XG4gICAgaWYodGhpcy5wcm9wcy5jb21taXQuY29tbWl0SGFzaC5zdWJzdHIoMCw2KSAhPT0gJzAwMDAwMCcpe1xuICAgICAgR2l0RGF0YS5nZXRDb21taXQodGhpcy5wcm9wcy5jb21taXQucmVwb1BhdGgsIHRoaXMucHJvcHMuY29tbWl0LmNvbW1pdEhhc2gpXG4gICAgICAgIC50aGVuKChjb21taXQpID0+IHtcbiAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICAgICAgICBjb21taXQgOiB7XG4gICAgICAgICAgICAgIC4uLnRoaXMuc3RhdGUuY29tbWl0LFxuICAgICAgICAgICAgICAuLi5jb21taXRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0SXNzdWVzRm9yUHVsbFJlcXVlc3QocHVsbFJlcXVlc3QpIHtcbiAgICBpZiAocHVsbFJlcXVlc3QpIHtcbiAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IFByb21pc2UuYWxsKHB1bGxSZXF1ZXN0LnJlbGF0ZWRJc3N1ZUtleXMubWFwKFxuICAgICAgICBpc3N1ZUtleSA9PiBJbnRlZ3JhdGlvbkRhdGEuZ2V0SXNzdWUodGhpcy5zdGF0ZS5jb21taXQucmVwb1BhdGgsIGlzc3VlS2V5KVxuICAgICAgKSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgLi4udGhpcy5zdGF0ZSwgaXNzdWVzIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgLi4udGhpcy5zdGF0ZSwgaXNzdWVzOiBbXSB9KVxuICAgIH1cbiAgfVxuXG4gIHRvb2x0aXAoKXtcbiAgICByZXR1cm4gKFxuICAgICAgPEJsYW1lVG9vbHRpcFxuICAgICAgICBlbWl0dGVyPXt0aGlzLnByb3BzLmVtaXR0ZXJ9XG4gICAgICAgIGNvbW1pdD17dGhpcy5zdGF0ZS5jb21taXR9XG4gICAgICAgIGNvbW1pdERheT17dGhpcy5wcm9wcy5jb21taXREYXl9XG4gICAgICAgIGZpcnN0Q29tbWl0RGF0ZT17dGhpcy5wcm9wcy5maXJzdENvbW1pdERhdGV9XG4gICAgICAgIHB1bGxSZXF1ZXN0cz17dGhpcy5zdGF0ZS5wdWxsUmVxdWVzdHN9XG4gICAgICAgIGlzc3Vlcz17dGhpcy5zdGF0ZS5pc3N1ZXN9XG4gICAgICAgIG1ldGFkYXRhPXt0aGlzLnN0YXRlLm1ldGFkYXRhfVxuICAgICAgLz5cbiAgICApXG4gIH1cblxuICBmb3JtYXR0ZWRUZXh0KCkge1xuICAgIGNvbnN0IGNvbW1pdCA9IHRoaXMucHJvcHMuY29tbWl0O1xuICAgIGNvbnN0IGRhdGUgPSBjb21taXQuY29tbWl0ZWRBdDtcbiAgICBjb25zdCBmb3JtYXR0ZWREYXRlID0gbW9tZW50KGRhdGUpLmZvcm1hdChDb25maWdNYW5hZ2VyLmdldCgnZ3V0dGVyRGF0ZUZvcm1hdCcpKTtcbiAgICBsZXQgYXV0aG9yID0gY29tbWl0LmF1dGhvcjtcbiAgICBpZiAoYXV0aG9yID09ICdOb3QgQ29tbWl0dGVkIFlldCcpXG4gICAgICByZXR1cm4gYCR7YXV0aG9yfWBcbiAgICBpZihDb25maWdNYW5hZ2VyLmdldCgndHJ1bmNhdGVHdXR0ZXJOYW1lcycpKXtcbiAgICAgIGNvbnN0IHNwbGl0QXV0aG9yID0gYXV0aG9yLnNwbGl0KCcgJyk7XG4gICAgICBpZihzcGxpdEF1dGhvci5sZW5ndGggPiAxKXtcbiAgICAgICAgY29uc3QgbGFzdE5hbWUgPSBzcGxpdEF1dGhvci5wb3AoKTtcbiAgICAgICAgY29uc3QgaW5pdGlhbHMgPSBzcGxpdEF1dGhvci5tYXAoKHBhcnQpID0+IHtcbiAgICAgICAgICByZXR1cm4gcGFydFswXS50b1VwcGVyQ2FzZSgpXG4gICAgICAgIH0pLmpvaW4oJyAnKTtcbiAgICAgICAgYXV0aG9yID0gYCR7aW5pdGlhbHN9LiAke2xhc3ROYW1lfWA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBgJHtmb3JtYXR0ZWREYXRlfSAke2F1dGhvcn1gXG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgaWYodGhpcy5zdGF0ZS5jb21taXQuY29tbWl0SGFzaC5zdWJzdHIoMCw2KSA9PT0gJzAwMDAwMCcpe1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJndXR0ZXItdGV4dFwiPlxuICAgICAgICAgIHt0aGlzLmZvcm1hdHRlZFRleHQoKX1cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPGRpdj5cbiAgICAgICAgPFRvb2x0aXBDb250YWluZXJcbiAgICAgICAgICBjbGFzc05hbWU9XCJndXR0ZXItdGV4dFwiXG4gICAgICAgICAgdG9vbHRpcENvbnRlbnQ9e3RoaXMudG9vbHRpcC5iaW5kKHRoaXMpfVxuICAgICAgICA+XG4gICAgICAgICAge3RoaXMuZm9ybWF0dGVkVGV4dCgpfVxuICAgICAgICA8L1Rvb2x0aXBDb250YWluZXI+XG4gICAgICAgIDxUb29sdGlwQ29udGFpbmVyXG4gICAgICAgICAgc3R5bGU9e3tiYWNrZ3JvdW5kOiB0aGlzLnByb3BzLmluaWRjYXRvckNvbG9yfX1cbiAgICAgICAgICBjbGFzc05hbWU9XCJndXR0ZXItYWdlXCJcbiAgICAgICAgLz5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBHdXR0ZXJJdGVtO1xuIl19
'use babel';
import { createSocket } from 'dgram';
import fs from 'fs';
import StepsizeHelper from './StepsizeHelper';
import { version } from '../../package.json';
class StepsizeOutgoing {
    constructor() {
        this.readyTries = 1;
        // sendError - sends error message to Stepsize
        this.sendError = data => {
            let editor = atom.workspace.getActiveTextEditor();
            if (!editor) {
                return;
            }
            let event = {
                source: 'atom',
                action: 'error',
                filename: fs.realpathSync(editor.getPath()),
                selected: JSON.stringify(data),
                plugin_id: this.pluginId,
            };
            this.send(event);
        };
        this.pluginId = `atom_v${version}`;
        this.DEBUG = false;
        this.UDP_HOST = '127.0.0.1';
        this.UDP_PORT = 49369;
        this.OUTGOING_SOCK = createSocket('udp4');
        this.layerReady = false;
        this.OUTGOING_SOCK.on('message', msg => {
            const parsedMessage = JSON.parse(msg);
            if (parsedMessage.type === 'ready' && parsedMessage.source.name === 'Layer') {
                this.layerReady = true;
                this.readyTries = 1;
                if (this.cachedMessage) {
                    this.send(this.cachedMessage);
                    this.cachedMessage = null;
                }
                clearInterval(this.readyInterval);
            }
        });
    }
    checkLayerIsReady() {
        if (this.layerReady) {
            return;
        }
        this.sendReady();
        this.readyCheckTimer();
    }
    readyCheckTimer() {
        this.readyRetryTimer = 3 * (Math.pow(this.readyTries / 10, 2) + 1);
        this.readyInterval = setTimeout(() => {
            this.readyTries++;
            this.sendReady();
            this.readyCheckTimer();
        }, this.readyRetryTimer * 1000);
    }
    send(event, callback) {
        StepsizeHelper.checkLayerRunning()
            .then(() => {
            let msg = JSON.stringify(event);
            this.OUTGOING_SOCK.send(msg, 0, msg.length, this.UDP_PORT, this.UDP_HOST, callback);
        })
            .catch(() => {
            this.layerReady = false;
            if (event.type !== 'ready') {
                this.cachedMessage = event;
                this.checkLayerIsReady();
                if (callback) {
                    callback();
                }
            }
        });
    }
    sendReady() {
        const event = {
            type: 'ready',
            source: { name: 'BetterGitBlame', version: version },
        };
        this.send(event);
    }
    buildSelectionEvent(editor) {
        const ranges = editor.selections.map(selection => {
            return selection.getBufferRange();
        });
        return this.buildEvent(editor, ranges, 'selection');
    }
    buildEvent(editor, ranges, action, shouldPerformSearch = false) {
        const selectedLineNumbers = StepsizeHelper.rangesToSelectedLineNumbers(ranges);
        return {
            source: 'atom',
            action: action,
            filename: editor.getPath() || null,
            plugin_id: this.pluginId,
            selectedLineNumbers,
            shouldPerformSearch: shouldPerformSearch,
        };
    }
}
export default StepsizeOutgoing;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RlcHNpemVPdXRnb2luZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zdGVwc2l6ZS9TdGVwc2l6ZU91dGdvaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQztBQUVaLE9BQU8sRUFBVSxZQUFZLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDN0MsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU3QztJQVlFO1FBSlEsZUFBVSxHQUFXLENBQUMsQ0FBQztRQW9FL0IsOENBQThDO1FBQzlDLGNBQVMsR0FBRyxJQUFJLENBQUMsRUFBRTtZQUNqQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNaLE1BQU0sQ0FBQztZQUNULENBQUM7WUFDRCxJQUFJLEtBQUssR0FBRztnQkFDVixNQUFNLEVBQUUsTUFBTTtnQkFDZCxNQUFNLEVBQUUsT0FBTztnQkFDZixRQUFRLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzNDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztnQkFDOUIsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRO2FBQ3pCLENBQUM7WUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25CLENBQUMsQ0FBQztRQTdFQSxJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsT0FBTyxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxXQUFXLENBQUM7UUFDNUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDdEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQ3JDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEMsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDNUUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7Z0JBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO2dCQUNwQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztvQkFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQzlCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO2dCQUM1QixDQUFDO2dCQUNELGFBQWEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDcEMsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUNwQixNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRU8sZUFBZTtRQUNyQixJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ25DLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDakIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3pCLENBQUMsRUFBRSxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTSxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVM7UUFDMUIsY0FBYyxDQUFDLGlCQUFpQixFQUFFO2FBQy9CLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdEYsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNWLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ3hCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO2dCQUN6QixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO29CQUNiLFFBQVEsRUFBRSxDQUFDO2dCQUNiLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsU0FBUztRQUNQLE1BQU0sS0FBSyxHQUFHO1lBQ1osSUFBSSxFQUFFLE9BQU87WUFDYixNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRTtTQUNyRCxDQUFDO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBa0JELG1CQUFtQixDQUFDLE1BQU07UUFDeEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDL0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxtQkFBbUIsR0FBRyxLQUFLO1FBQzVELE1BQU0sbUJBQW1CLEdBQUcsY0FBYyxDQUFDLDJCQUEyQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9FLE1BQU0sQ0FBQztZQUNMLE1BQU0sRUFBRSxNQUFNO1lBQ2QsTUFBTSxFQUFFLE1BQU07WUFDZCxRQUFRLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLElBQUk7WUFDbEMsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3hCLG1CQUFtQjtZQUNuQixtQkFBbUIsRUFBRSxtQkFBbUI7U0FDekMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQUVELGVBQWUsZ0JBQWdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IHsgU29ja2V0LCBjcmVhdGVTb2NrZXQgfSBmcm9tICdkZ3JhbSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IFN0ZXBzaXplSGVscGVyIGZyb20gJy4vU3RlcHNpemVIZWxwZXInO1xuaW1wb3J0IFRpbWVyID0gTm9kZUpTLlRpbWVyO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7XG5cbmNsYXNzIFN0ZXBzaXplT3V0Z29pbmcge1xuICBwcml2YXRlIHBsdWdpbklkO1xuICBwcml2YXRlIERFQlVHOiBib29sZWFuO1xuICBwcml2YXRlIFVEUF9IT1NUOiBzdHJpbmc7XG4gIHByaXZhdGUgVURQX1BPUlQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBPVVRHT0lOR19TT0NLOiBTb2NrZXQ7XG4gIHByaXZhdGUgbGF5ZXJSZWFkeTogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkeUludGVydmFsOiBUaW1lcjtcbiAgcHJpdmF0ZSByZWFkeVRyaWVzOiBudW1iZXIgPSAxO1xuICBwcml2YXRlIHJlYWR5UmV0cnlUaW1lcjogbnVtYmVyO1xuICBwcml2YXRlIGNhY2hlZE1lc3NhZ2U6IGFueTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnBsdWdpbklkID0gYGF0b21fdiR7dmVyc2lvbn1gO1xuICAgIHRoaXMuREVCVUcgPSBmYWxzZTtcbiAgICB0aGlzLlVEUF9IT1NUID0gJzEyNy4wLjAuMSc7XG4gICAgdGhpcy5VRFBfUE9SVCA9IDQ5MzY5O1xuICAgIHRoaXMuT1VUR09JTkdfU09DSyA9IGNyZWF0ZVNvY2tldCgndWRwNCcpO1xuICAgIHRoaXMubGF5ZXJSZWFkeSA9IGZhbHNlO1xuICAgIHRoaXMuT1VUR09JTkdfU09DSy5vbignbWVzc2FnZScsIG1zZyA9PiB7XG4gICAgICBjb25zdCBwYXJzZWRNZXNzYWdlID0gSlNPTi5wYXJzZShtc2cpO1xuICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UudHlwZSA9PT0gJ3JlYWR5JyAmJiBwYXJzZWRNZXNzYWdlLnNvdXJjZS5uYW1lID09PSAnTGF5ZXInKSB7XG4gICAgICAgIHRoaXMubGF5ZXJSZWFkeSA9IHRydWU7XG4gICAgICAgIHRoaXMucmVhZHlUcmllcyA9IDE7XG4gICAgICAgIGlmICh0aGlzLmNhY2hlZE1lc3NhZ2UpIHtcbiAgICAgICAgICB0aGlzLnNlbmQodGhpcy5jYWNoZWRNZXNzYWdlKTtcbiAgICAgICAgICB0aGlzLmNhY2hlZE1lc3NhZ2UgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5yZWFkeUludGVydmFsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tMYXllcklzUmVhZHkoKSB7XG4gICAgaWYgKHRoaXMubGF5ZXJSZWFkeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNlbmRSZWFkeSgpO1xuICAgIHRoaXMucmVhZHlDaGVja1RpbWVyKCk7XG4gIH1cblxuICBwcml2YXRlIHJlYWR5Q2hlY2tUaW1lcigpIHtcbiAgICB0aGlzLnJlYWR5UmV0cnlUaW1lciA9IDMgKiAoTWF0aC5wb3codGhpcy5yZWFkeVRyaWVzIC8gMTAsIDIpICsgMSk7XG4gICAgdGhpcy5yZWFkeUludGVydmFsID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnJlYWR5VHJpZXMrKztcbiAgICAgIHRoaXMuc2VuZFJlYWR5KCk7XG4gICAgICB0aGlzLnJlYWR5Q2hlY2tUaW1lcigpO1xuICAgIH0sIHRoaXMucmVhZHlSZXRyeVRpbWVyICogMTAwMCk7XG4gIH1cblxuICBwdWJsaWMgc2VuZChldmVudCwgY2FsbGJhY2s/KSB7XG4gICAgU3RlcHNpemVIZWxwZXIuY2hlY2tMYXllclJ1bm5pbmcoKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBsZXQgbXNnID0gSlNPTi5zdHJpbmdpZnkoZXZlbnQpO1xuICAgICAgICB0aGlzLk9VVEdPSU5HX1NPQ0suc2VuZChtc2csIDAsIG1zZy5sZW5ndGgsIHRoaXMuVURQX1BPUlQsIHRoaXMuVURQX0hPU1QsIGNhbGxiYWNrKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICB0aGlzLmxheWVyUmVhZHkgPSBmYWxzZTtcbiAgICAgICAgaWYgKGV2ZW50LnR5cGUgIT09ICdyZWFkeScpIHtcbiAgICAgICAgICB0aGlzLmNhY2hlZE1lc3NhZ2UgPSBldmVudDtcbiAgICAgICAgICB0aGlzLmNoZWNrTGF5ZXJJc1JlYWR5KCk7XG4gICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBzZW5kUmVhZHkoKSB7XG4gICAgY29uc3QgZXZlbnQgPSB7XG4gICAgICB0eXBlOiAncmVhZHknLFxuICAgICAgc291cmNlOiB7IG5hbWU6ICdCZXR0ZXJHaXRCbGFtZScsIHZlcnNpb246IHZlcnNpb24gfSxcbiAgICB9O1xuICAgIHRoaXMuc2VuZChldmVudCk7XG4gIH1cblxuICAvLyBzZW5kRXJyb3IgLSBzZW5kcyBlcnJvciBtZXNzYWdlIHRvIFN0ZXBzaXplXG4gIHNlbmRFcnJvciA9IGRhdGEgPT4ge1xuICAgIGxldCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG4gICAgaWYgKCFlZGl0b3IpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGV2ZW50ID0ge1xuICAgICAgc291cmNlOiAnYXRvbScsXG4gICAgICBhY3Rpb246ICdlcnJvcicsXG4gICAgICBmaWxlbmFtZTogZnMucmVhbHBhdGhTeW5jKGVkaXRvci5nZXRQYXRoKCkpLFxuICAgICAgc2VsZWN0ZWQ6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxuICAgICAgcGx1Z2luX2lkOiB0aGlzLnBsdWdpbklkLFxuICAgIH07XG4gICAgdGhpcy5zZW5kKGV2ZW50KTtcbiAgfTtcblxuICBidWlsZFNlbGVjdGlvbkV2ZW50KGVkaXRvcikge1xuICAgIGNvbnN0IHJhbmdlcyA9IGVkaXRvci5zZWxlY3Rpb25zLm1hcChzZWxlY3Rpb24gPT4ge1xuICAgICAgcmV0dXJuIHNlbGVjdGlvbi5nZXRCdWZmZXJSYW5nZSgpO1xuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmJ1aWxkRXZlbnQoZWRpdG9yLCByYW5nZXMsICdzZWxlY3Rpb24nKTtcbiAgfVxuXG4gIGJ1aWxkRXZlbnQoZWRpdG9yLCByYW5nZXMsIGFjdGlvbiwgc2hvdWxkUGVyZm9ybVNlYXJjaCA9IGZhbHNlKSB7XG4gICAgY29uc3Qgc2VsZWN0ZWRMaW5lTnVtYmVycyA9IFN0ZXBzaXplSGVscGVyLnJhbmdlc1RvU2VsZWN0ZWRMaW5lTnVtYmVycyhyYW5nZXMpO1xuICAgIHJldHVybiB7XG4gICAgICBzb3VyY2U6ICdhdG9tJyxcbiAgICAgIGFjdGlvbjogYWN0aW9uLFxuICAgICAgZmlsZW5hbWU6IGVkaXRvci5nZXRQYXRoKCkgfHwgbnVsbCxcbiAgICAgIHBsdWdpbl9pZDogdGhpcy5wbHVnaW5JZCxcbiAgICAgIHNlbGVjdGVkTGluZU51bWJlcnMsXG4gICAgICBzaG91bGRQZXJmb3JtU2VhcmNoOiBzaG91bGRQZXJmb3JtU2VhcmNoLFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU3RlcHNpemVPdXRnb2luZztcbiJdfQ==